import { authMiddleware } from '../middleware/auth.js';
import { queryAll, execute } from '../lib/db.js';
import multer from 'multer';
import csvParser from 'csv-parser';
import { Readable } from 'stream';

const upload = multer({ 
  storage: multer.memoryStorage(),
  limits: { fileSize: 10 * 1024 * 1024 }
});

const SECTEUR_KEYWORDS = {
  juridique: ['avocat', 'notaire', 'huissier', 'juridique', 'legal', 'droit'],
  comptabilite: ['comptable', 'expert comptable', 'audit', 'expertise comptable'],
  sante: ['medical', 'medecin', 'pharmacie', 'dentiste', 'kine', 'sante', 'clinique'],
  informatique: ['informatique', 'digital', 'web', 'software', 'dev', 'tech', 'it'],
  btp: ['btp', 'construction', 'maconnerie', 'plomberie', 'electricite', 'batiment'],
  hotellerie: ['restaurant', 'hotel', 'cafe', 'bar', 'traiteur', 'restauration'],
  immobilier: ['immobilier', 'agence immobiliere', 'syndic', 'promoteur'],
  logistique: ['transport', 'logistique', 'livraison', 'entreposage'],
  commerce: ['commerce', 'boutique', 'magasin', 'vente', 'retail'],
  education: ['ecole', 'formation', 'education', 'enseignement'],
  consulting: ['conseil', 'consulting', 'consultant', 'strategie'],
  rh: ['recrutement', 'rh', 'ressources humaines', 'interim'],
  services: ['nettoyage', 'maintenance', 'gardiennage', 'securite'],
  industrie: ['industrie', 'usine', 'fabrication', 'production'],
  automobile: ['garage', 'automobile', 'carrosserie', 'concessionnaire']
};

function detectSector(companyName) {
  if (!companyName) return 'autre';
  const lowerName = companyName.toLowerCase();
  for (const [sector, keywords] of Object.entries(SECTEUR_KEYWORDS)) {
    for (const keyword of keywords) {
      if (lowerName.includes(keyword)) return sector;
    }
  }
  return 'autre';
}

function isValidEmail(email) {
  if (!email) return false;
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

async function handler(req, res) {
  const tenant_id = req.user.tenant_id;

  try {
    if (req.method === 'GET') {
      const leads = await queryAll(
        'SELECT * FROM leads WHERE tenant_id = $1 ORDER BY created_at DESC',
        [tenant_id]
      );
      return res.status(200).json({ success: true, leads: leads || [] });
    }

    if (req.method === 'POST' && req.url.includes('/analyze-csv')) {
      return new Promise((resolve) => {
        upload.single('file')(req, res, async (err) => {
          if (err) return resolve(res.status(400).json({ error: 'Erreur upload' }));
          if (!req.file) return resolve(res.status(400).json({ error: 'Aucun fichier' }));

          try {
            const leads = [];
            const segmentation = {};
            let validLeads = 0;

            Readable.from(req.file.buffer.toString())
              .pipe(csvParser())
              .on('data', (row) => {
                const normalizedRow = {};
                Object.keys(row).forEach(key => {
                  normalizedRow[key.toLowerCase().trim().replace(/\s+/g, '_')] = row[key];
                });

                const company_name = normalizedRow.company_name || '';
                const email = normalizedRow.email || '';

                if (company_name && isValidEmail(email)) {
                  validLeads++;
                  const sector = detectSector(company_name);
                  segmentation[sector] = (segmentation[sector] || 0) + 1;
                  leads.push({
                    company_name,
                    email,
                    phone: normalizedRow.phone || null,
                    city: normalizedRow.city || null,
                    industry: sector
                  });
                }
              })
              .on('end', () => {
                resolve(res.json({
                  success: true,
                  analysis: { totalLeads: leads.length, validLeads, segmentation, leads: leads.slice(0, 10) }
                }));
              })
              .on('error', () => resolve(res.status(500).json({ error: 'Erreur analyse' })));
          } catch (error) {
            resolve(res.status(500).json({ error: 'Erreur serveur' }));
          }
        });
      });
    }

    if (req.method === 'POST' && req.url.includes('/import-csv')) {
      const { name, description, source, fileName, segmentation } = req.body;
      if (!name) return res.status(400).json({ error: 'Nom requis' });

      const database = await execute(
        `INSERT INTO lead_databases (tenant_id, name, description, source, file_name, total_leads, segmentation, created_by)
         VALUES ($1, $2, $3, $4, $5, 0, $6, $7) RETURNING *`,
        [tenant_id, name, description, source, fileName, JSON.stringify(segmentation), req.user.id]
      );

      return res.status(201).json({ success: true, database });
    }

    if (req.method === 'POST' && req.url.includes('/import-batch')) {
      return new Promise((resolve) => {
        upload.single('file')(req, res, async (err) => {
          if (err) return resolve(res.status(400).json({ error: 'Erreur upload' }));

          const { database_id } = req.body;
          if (!database_id) return resolve(res.status(400).json({ error: 'database_id requis' }));

          try {
            let importedCount = 0;
            const batch = [];
            const BATCH_SIZE = 50;

            Readable.from(req.file.buffer.toString())
              .pipe(csvParser())
              .on('data', (row) => {
                const normalizedRow = {};
                Object.keys(row).forEach(key => {
                  normalizedRow[key.toLowerCase().trim().replace(/\s+/g, '_')] = row[key];
                });

                const company_name = normalizedRow.company_name || '';
                const email = normalizedRow.email || '';

                if (company_name && isValidEmail(email)) {
                  batch.push({
                    tenant_id,
                    database_id,
                    company_name,
                    email,
                    phone: normalizedRow.phone || null,
                    city: normalizedRow.city || null,
                    industry: detectSector(company_name),
                    status: 'nouveau',
                    score: 50
                  });
                }
              })
              .on('end', async () => {
                try {
                  // Insérer par lots de 50
                  for (let i = 0; i < batch.length; i += BATCH_SIZE) {
                    const chunk = batch.slice(i, i + BATCH_SIZE);
                    
                    for (const lead of chunk) {
                      try {
                        await execute(
                          `INSERT INTO leads (tenant_id, database_id, company_name, email, phone, city, industry, status, score)
                           VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)`,
                          [lead.tenant_id, lead.database_id, lead.company_name, lead.email, lead.phone, lead.city, lead.industry, lead.status, lead.score]
                        );
                        importedCount++;
                      } catch (insertError) {
                        console.error('Erreur insert lead:', insertError);
                      }
                    }
                  }

                  await execute('UPDATE lead_databases SET total_leads = $1 WHERE id = $2', [importedCount, database_id]);
                  resolve(res.json({ success: true, imported: importedCount }));
                } catch (error) {
                  console.error('Erreur import batch:', error);
                  resolve(res.status(500).json({ error: 'Erreur import' }));
                }
              })
              .on('error', () => resolve(res.status(500).json({ error: 'Erreur lecture CSV' })));
          } catch (error) {
            resolve(res.status(500).json({ error: 'Erreur serveur' }));
          }
        });
      });
    }

    return res.status(405).json({ error: 'Method not allowed' });
  } catch (error) {
    console.error('Leads error:', error);
    return res.status(500).json({ error: 'Server error' });
  }
}

export default authMiddleware(handler);
