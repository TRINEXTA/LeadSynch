import axios from 'axios';

export function getElasticEmailService() {
  const API_KEY = process.env.ELASTIC_EMAIL_API_KEY;
  
  if (!API_KEY) {
    throw new Error('ELASTIC_EMAIL_API_KEY manquant dans .env');
  }
  
  // Détection automatique de l'URL de base
  const getBaseUrl = () => {
    if (process.env.APP_URL) {
      return process.env.APP_URL;
    }
    
    if (process.env.NODE_ENV === 'production') {
      return 'https://leadsynch.com';
    }
    
    return 'http://localhost:3000';
  };
  
  const BASE_URL = getBaseUrl();
  
  return {
    async sendEmail({ from, to, subject, htmlBody, replyTo, leadId, campaignId }) {
      try {
        let trackedHtml = htmlBody;
        
        if (leadId && campaignId) {
          const trackingPixel = `<img src="${BASE_URL}/api/track/open?lead_id=${leadId}&campaign_id=${campaignId}" width="1" height="1" style="display:none;" alt="" />`;
          trackedHtml += trackingPixel;
          
          trackedHtml = trackedHtml.replace(
            /<a\s+([^>]*?)href=["']([^"']+)["']([^>]*)>/gi,
            (match, before, url, after) => {
              if (url.includes('/api/track/')) {
                return match;
              }
              
              const trackedUrl = `${BASE_URL}/api/track/click?lead_id=${leadId}&campaign_id=${campaignId}&url=${encodeURIComponent(url)}`;
              return `<a ${before}href="${trackedUrl}"${after}>`;
            }
          );
        }
        
        const response = await axios.post(
          'https://api.elasticemail.com/v2/email/send',
          null,
          {
            params: {
              apikey: API_KEY,
              from: from || process.env.EMAIL_FROM || 'noreply@leadsynch.com',
              to,
              subject,
              bodyHtml: trackedHtml,
              replyTo: replyTo || from || process.env.EMAIL_FROM,
              isTransactional: false
            },
            timeout: 30000
          }
        );
        
        if (response.data.success === true) {
          return {
            success: true,
            messageId: response.data.data?.messageid || 'unknown'
          };
        } else {
          return {
            success: false,
            error: response.data.error || 'Erreur inconnue'
          };
        }
      } catch (error) {
        console.error('❌ Erreur ElasticEmail:', error.response?.data || error.message);
        return {
          success: false,
          error: error.response?.data?.error || error.message
        };
      }
    }
  };
}